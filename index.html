<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Social Hobby Network</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: Arial, sans-serif; max-width: 600px; margin: auto; padding: 20px; }
    h1 { text-align: center; }
    .post { border: 1px solid #ddd; padding: 10px; margin: 10px 0; border-radius: 8px; }
    .post-header { display: flex; align-items: center; gap: 10px; margin-bottom: 5px; }
    .avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
    .avatar.placeholder { background: #ccc; display: inline-block; }
    textarea { width: 100%; min-height: 60px; }
    button { margin-top: 5px; padding: 5px 10px; }
  </style>
</head>
<body>
  <h1>Social Hobby Network</h1>

  <!-- Auth Section -->
  <div id="auth-section">
    <h2>Sign Up / Login</h2>
    <input type="email" id="email" placeholder="Email" /><br>
    <input type="password" id="password" placeholder="Password" /><br>
    <button onclick="signUp()">Sign Up</button>
    <button onclick="signIn()">Login</button>
  </div>

  <!-- Avatar Section -->
  <div id="avatar-section" style="display:none;">
    <h3>Upload Profile Picture</h3>
    <input type="file" id="avatarUpload" />
    <button onclick="uploadAvatar()">Upload</button><br>
    <img id="avatarPreview" src="" alt="Your avatar" width="100" style="margin-top:10px;" />
  </div>

  <!-- Post Section -->
  <div id="post-section" style="display:none;">
    <h2>Create Post</h2>
    <textarea id="postContent" placeholder="Write something..."></textarea>
    <button onclick="createPost()">Post</button>
    <h2>Feed</h2>
    <div id="feed"></div>
  </div>

<script>
const SUPABASE_URL = "https://kyqzckrnmvoafjajxncr.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt5cXpja3JubXZvYWZqYWp4bmNyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUzMDQ1MjMsImV4cCI6MjA3MDg4MDUyM30.naSMdTVqXngWBOCd_0Rml28crAhnGwPoLTVh7sLNlqQ";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// Sign up
async function signUp() {
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;
  let { error } = await supabase.auth.signUp({ email, password });
  if (error) alert(error.message);
  else alert("Check your email for confirmation link!");
}

// Sign in
async function signIn() {
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;
  let { error } = await supabase.auth.signInWithPassword({ email, password });
  if (error) alert(error.message);
  else {
    document.getElementById("auth-section").style.display = "none";
    document.getElementById("avatar-section").style.display = "block";
    document.getElementById("post-section").style.display = "block";
    loadPosts();
  }
}

// Create a post
async function createPost() {
  const content = document.getElementById("postContent").value;
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) return alert("Not logged in");

  const { error } = await supabase.from("posts").insert([
    { user_id: user.id, content }
  ]);
  if (error) alert(error.message);
  else {
    document.getElementById("postContent").value = "";
    loadPosts();
  }
}

// Load posts
async function loadPosts() {
  const { data, error } = await supabase
    .from("posts")
    .select(`
      id, content, created_at,
      profiles(username, avatar_url)
    `)
    .order("created_at", { ascending: false });

  if (error) {
    console.error(error);
    return;
  }

  const feed = document.getElementById("feed");
  feed.innerHTML = "";

  data.forEach(post => {
    const postDiv = document.createElement("div");
    postDiv.className = "post";

    const avatar = post.profiles?.avatar_url 
      ? `<img src="${post.profiles.avatar_url}" class="avatar">`
      : `<div class="avatar placeholder"></div>`;

    const username = post.profiles?.username || "Anonymous";

    postDiv.innerHTML = `
      <div class="post-header">
        ${avatar}
        <span class="username">${username}</span>
        <span class="date">${new Date(post.created_at).toLocaleString()}</span>
      </div>
      <div class="post-content">${post.content}</div>
    `;

    feed.appendChild(postDiv);
  });
}

// Upload avatar
async function uploadAvatar() {
  const file = document.getElementById("avatarUpload").files[0];
  if (!file) return alert("Select a file first");

  const { data: { user } } = await supabase.auth.getUser();
  if (!user) return alert("You must be logged in");

  const fileExt = file.name.split(".").pop();
  const fileName = `${user.id}.${fileExt}`;
  const filePath = `${fileName}`;

  let { error: uploadError } = await supabase.storage
    .from("avatars")
    .upload(filePath, file, { upsert: true });

  if (uploadError) {
    alert("Upload failed: " + uploadError.message);
    return;
  }

  const { data } = supabase.storage.from("avatars").getPublicUrl(filePath);
  const publicUrl = data.publicUrl;

  const { error: profileError } = await supabase
    .from("profiles")
    .update({ avatar_url: publicUrl })
    .eq("id", user.id);

  if (profileError) {
    alert("Could not save avatar URL");
    return;
  }

  document.getElementById("avatarPreview").src = publicUrl;
  alert("Avatar uploaded!");
  loadPosts();
}
</script>
</body>
</html>
