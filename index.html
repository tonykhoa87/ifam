<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Social Hobby App</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="container">
    <h1>ðŸŽ‰ Social Hobby Network</h1>

    <!-- Auth Section -->
    <div id="auth-section">
      <h2>Sign Up / Login</h2>
      <input type="email" id="email" placeholder="Email">
      <input type="password" id="password" placeholder="Password">
      <button onclick="signUp()">Sign Up</button>
      <button onclick="signIn()">Login</button>
    </div>

    <!-- Avatar Section -->
    <div id="avatar-section" style="display:none;">
      <h3>Upload Profile Picture</h3>
      <input type="file" id="avatarUpload" onchange="uploadAvatar(event)" />
      <br>
      <img id="avatarPreview" src="" alt="Your avatar" width="100" style="margin-top:10px;" />
    </div>

    <!-- Post Section -->
    <div id="post-section" style="display:none;">
      <h2>Create Post</h2>
      <textarea id="postContent" placeholder="Write something..."></textarea>
      <button onclick="createPost()">Post</button>
      <h2>Feed</h2>
      <div id="feed"></div>
    </div>
  </div>

<script>
const SUPABASE_URL = "https://kyqzckrnmvoafjajxncr.supabase.co"; 
const SUPABASE_ANON_KEY = "YOUR_ANON_KEY_HERE"; 
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// --- AUTH ---

async function signUp() {
  const email = document.getElementById('email').value;
  const password = document.getElementById('password').value;
  let { error } = await supabase.auth.signUp({ email, password });
  if (error) return alert(error.message);

  alert("Check your email for confirmation link!");

  // âœ… Insert profile row
  const { data: { user } } = await supabase.auth.getUser();
  if (user) {
    await supabase.from("profiles").upsert([
      { id: user.id, username: email.split("@")[0] }
    ]);
  }
}

async function signIn() {
  const email = document.getElementById('email').value;
  const password = document.getElementById('password').value;
  let { data, error } = await supabase.auth.signInWithPassword({ email, password });

  if (error) return alert(error.message);

  const user = data.user;

  // âœ… Ensure profile exists
  await supabase.from("profiles").upsert([
    { id: user.id, username: email.split("@")[0] }
  ]);

  document.getElementById('auth-section').style.display = 'none';
  document.getElementById('avatar-section').style.display = 'block';
  document.getElementById('post-section').style.display = 'block';

  loadPosts();
}

// --- POSTS ---

async function createPost() {
  const content = document.getElementById('postContent').value;
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) return alert("Not logged in");

  const { error } = await supabase.from('posts').insert([
    { user_id: user.id, content }
  ]);
  if (error) {
    alert(error.message);
  } else {
    document.getElementById('postContent').value = '';
    loadPosts();
  }
}

async function loadPosts() {
  const { data, error } = await supabase
    .from("posts")
    .select(`
      id, content, created_at,
      profiles ( username, avatar_url )
    `)
    .order("created_at", { ascending: false });

  if (error) {
    console.error("Error loading posts:", error);
    return;
  }

  const feed = document.getElementById("feed");
  feed.innerHTML = "";

  data.forEach(post => {
    const postDiv = document.createElement("div");
    postDiv.className = "post";

    const avatar = post.profiles?.avatar_url 
      ? `<img src="${post.profiles.avatar_url}" class="avatar">`
      : `<div class="avatar placeholder"></div>`;

    const username = post.profiles?.username || "Anonymous";

    postDiv.innerHTML = `
      <div class="post-header">
        ${avatar}
        <span class="username">${username}</span>
        <span class="date">${new Date(post.created_at).toLocaleString()}</span>
      </div>
      <div class="post-content">${post.content}</div>
    `;

    feed.appendChild(postDiv);
  });
}

// --- AVATAR ---

async function uploadAvatar(event) {
  const file = event.target.files[0];
  if (!file) return;

  const { data: { user } } = await supabase.auth.getUser();
  if (!user) return alert("You must be logged in to upload an avatar.");

  const fileExt = file.name.split('.').pop();
  const fileName = `${user.id}.${fileExt}`;
  const filePath = `${fileName}`;

  let { error: uploadError } = await supabase.storage
    .from('avatars')
    .upload(filePath, file, { upsert: true });

  if (uploadError) {
    console.error("Upload failed:", uploadError);
    alert("Upload failed: " + uploadError.message);
    return;
  }

  const { data } = supabase.storage.from("avatars").getPublicUrl(filePath);
  const avatarUrl = data.publicUrl;

  const { error: dbError } = await supabase
    .from("profiles")
    .update({ avatar_url: avatarUrl })
    .eq("id", user.id);

  if (dbError) {
    console.error("Database error:", dbError.message);
    alert("Avatar uploaded, but saving to profile failed.");
  } else {
    document.getElementById("avatarPreview").src = avatarUrl;
    alert("Avatar uploaded and saved!");
    loadPosts();
  }
}
</script>
</body>
</html>
